<!DOCTYPE html>
<html>
<head>
    <title>期货辅助工具</title>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <!--<link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}"> -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.min.css">
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css">
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>

{#    <link rel="stylesheet" href="/styles.css">#}


    <style>
        #row1 {
            height: 550px;
            display: flex;
            justify-content: space-between;
        }

        #row1 h3 { text-align: center; margin: 0; }

        #row2 {
            height: 350px;
            display: flex;
            justify-content: space-between;
        }
        #row3 {
            height: 750px;
            display: flex;
            justify-content: space-between;
        }
        #row4 {
            height: 150px;
            display: flex;
            justify-content: space-between;
        }
        .column {

        }
        .mydatatable {
            font-size: 2px;
        }


    </style>

</head>



<body>
    <script src="D:/00_Program/77_optionSoft/0_Code/fut/tb_trend_use.js"></script>
    <div id="row0" class="ui-widget-content">
        &nbsp;&nbsp;品种
        <select id="futid" style="width: 60px;">
            <option value="i">i</option>
            <option value="p">p</option>
{#            <option value="CF">CF</option>#}
{#            <option value="SR">SR</option>#}
        </select>
        &nbsp;合约<!--默认选择主力合约-->
        <select id="monthid" style="width: 80px;">
            <option value="2201">2201</option>
            <option value="2205">2205</option>
            <option value="2209">2209</option>
        </select>
        &nbsp;&nbsp;&nbsp;日期范围
        <input id="stdt" type="text" style="width: 90px;">
        <input id="endt" type="text" style="width: 90px;">
            bar周期
        <select id="bar_period" style="width: 80px;">
            <option value="日线">日线</option>
            <option value="半小时">半小时</option>
            <option value="3分钟">3分钟</option>
        </select>

        <button id="update_dtrange">更新</button>
    </div>
    <div id="row1" class="ui-widget-content">
        <!--<h3 class="ui-widget-header">Resizable</h3>-->
        <div id="barfig" class="ui-widget-content column" style="width: 70%; height: 100%;"></div>
        <div id="warninglist" class="ui-widget-content column" style="overflow: auto; z-index: 9999;">
            <div class="ui-widget-header"> 信息列表 </div>
        </div>

    </div>
    <div id="row2" class="ui-widget-content">
        <div id="trenddf" class="ui-widget-content column" style="width: 70%; height: 100%;">
            <table id="tb_trend" class="display" style="width: 100%; height: 100%;"></table>
        </div>
        <div id="trend1" class="ui-widget-content column" style="overflow: auto;">
            <div class="ui-widget-header"> 形态单个 </div>
            <form>
                <p>周期
{#                <input type="text" id="r2_period_type">#}
                    <select id="r2_period_type" style="width: 80px;">
                    <option value="波段2">波段2</option>
                    <option value="波段1">波段1</option>
                    <option value="波段0">波段0</option>
                    <option value="日线">日线</option>
                    <option value="半小时">半小时</option>
                    <option value="3分钟">3分钟</option>
                    </select>
                </p>

                <p>起始时间<input type="text" id="r2_stdt"></p>
                <p>终止时间<input type="text" id="r2_endt"></p>

                <p>方向
{#                    <input type="text" id="r2_trend_dir">#}
                    <select id="r2_trend_dir" style="width: 80px;">
                    <option value="1">1</option>
                    <option value="0">0</option>
                    <option value="-1">-1</option>
                </select>
                </p>
                <p>波段类型
                    <select id="r2_trend_type" style="width: 80px;">
                    <option value="之字形">之字形</option>
                    <option value="N字形">N字形</option>
                    <option value="阶梯形">阶梯形</option>
                    </select>
                </p>
                <p>点列表<input type="text" id="r2_pts"> <button type="button" id="r2_pt_set">设置</button>  </p>
                <p>趋势线<input type="text" id="r2_line"><button type="button" id="r2_line_set">设置</button>  </p>
                <p>形态
{#                    <input type="text" id="r2_typelist">#}
                    <select multiple id="r2_typelist" style="width: 240px;">
                    <option value="杯柄形态">杯柄形态</option>
                    <option value="三角形">三角形</option>
                    <option value="岛型反转">岛形反转</option>
                    <option value="顺向孤岛">顺向孤岛</option>
                    <option value="三重顶底">三重顶底</option>
                    <option value="双顶底">双顶底</option>
                    <option value="2b牛角">2b牛角</option>
                    <option value="矩形/高锦旗形">矩形/高锦旗形</option>
                    <option value="圆弧顶底">圆弧顶底</option>
                    <option value="塔形顶底">塔形顶底</option>
                    <option value="独轮震荡">独轮震荡</option>
                    <option value="四肩顶">四肩顶</option>
                    </select>
                </p>

                <p>
                    <!-- 创建三个按钮，用于添加、删除、更新数据 -->
                    <button type="button" id="r2_add">添加</button>
                    <button type="button" id="r2_delete">删除</button>
                    <button type="button" id="r2_update">更新</button>
                </p>
            </form>
        </div>
    </div>
    <div id="row3" class="ui-widget-content">
        <div id="barrierdf" class="ui-widget-content column" style="width: 70%; height: 100%;">
            <table id="tb_barrier" class="display" style="width: 100%; height: 100%;"></table>
        </div>
        <div id="barrier1" class="ui-widget-content column" style="overflow: auto;">
            <div class="ui-widget-header"> 掩体单个 </div>
            <form>
                <p>掩体级别
                    <select id="r3_barrier_level" style="width: 80px;">
                    <option value="重要">重要</option>
                    <option value="平仓">平仓</option>
                    </select>
                </p>
                <p>掩体类型
                    <select id="r3_barrier_type" style="width: 80px;">
                    <option value="假突破">假突破</option>
                    <option value="趋势线">趋势线</option>
                    <option value="支撑压力">支撑压力</option>
                    <option value="跳空缺口">跳空缺口</option>
                    </select>
                </p>

                <p>掩体线<input type="text" id="r3_line"><button type="button" id="r3_line_set">设置</button>  </p>
                <p>
                    <!-- 创建三个按钮，用于添加、删除、更新数据 -->
                    <button type="button" id="r3_add">添加</button>
                    <button type="button" id="r3_delete">删除</button>
                    <button type="button" id="r3_update">更新</button>
                </p>
            </form>
        </div>
    </div>
{#    <div id="row4" class="ui-widget-content">#}
{#        <div id="ruledf" class="ui-widget-content column" style="width: 70%; height: 100%;">规则</div>#}
{#        <div id="rule1" class="ui-widget-content column" style="overflow: auto;">#}
{#            <div class="ui-widget-header"> 以后加入规则用#}
{##}
{#            </div>#}
{##}
{#        </div>#}
{#    </div>#}

    <script>
        var pt_set_type = 0;
        var line_set_type = 0;
        var r3line_set_type = 0;

        // var points = [];
        // var line = [];
        var drawnPoints = {};
        var drawnLine = [];

        var mouseButton;
        var chartDiv = document.getElementById('barfig');

        // plotly candlestick相关
        var graphs = {{ graphJSON | safe }};
        var layout1 = {
            margin:{b:10, l:50, r:10, t:50},
            title:{text:'行情图'},
            autosize: true,
            //paper_bgcolor: 'black',
            plot_bgcolor: 'black',
            dragmode: 'zoom',
            showlegend: false,
            xaxis: {
                showgrid: false,
                gridcolor: 'gray',
                autorange: true,
                gridwidth: 0.5,
                grid_dash: 'dash',
                type: 'category', //'date', 'category'
                tickmode: 'linear',
                tick0: 0,
                showticklabels: false, // 临时隐藏！TODO
                //tickvals: dates.filter(function(_, i) { return i % Math.round(dates.length / 10) === 0; })  // 只显示10个主要的坐标值
                //tickformat: '%Y-%m'  // 设置日期格式为'年-月'
                //dtick: 5
                //tickformat: '%Y-%m-%d %H:%M' // type:'date' 才有用
            },
            yaxis: {
                gridcolor: 'gray',
                autorange: true,
                gridwidth: 1,
                grid_dash: 'dashdot',
                type: 'linear'
            }
        };
        let myplot = Plotly.newPlot('barfig', graphs.data, layout1);
        var update = {
            'increasing.line.color': '#FF3333',
            'decreasing.line.color': 'rgba(0,255,0,0.56)' //'#33FF33'
        }
        Plotly.update('barfig', update);
        //Plotly.newPlot('barfig', graphs.data, graphs.layout);

        $(document).ready(function() {
            var parentWidth = $("#row1").width();
            var column1Width = $("#barfig").width();
            var column2Width = parentWidth - column1Width;
            $("#warninglist").width(column2Width);

            var parentWidth = $("#row2").width();
            var column1Width = $("#trenddf").width();
            var column2Width = parentWidth - column1Width;
            $("#trend1").width(column2Width);

            var parentWidth = $("#row3").width();
            var column1Width = $("#barrierdf").width();
            var column2Width = parentWidth - column1Width;
            $("#barrier1").width(column2Width);

            {#var parentWidth = $("#row4").width();#}
            {#var column1Width = $("#ruledf").width();#}
            {#var column2Width = parentWidth - column1Width;#}
            {#$("#rule1").width(column2Width);#}

            $("#barfig").resizable({
                handles: 'e',
                resize: function(event, ui) {
                    var parentWidth = $(this).parent().width();
                    var column1Width = $(this).width();
                    var column2Width = parentWidth - column1Width;
                    $("#warninglist").width(column2Width);
                }
            });
            $("#trenddf").resizable({
                handles: 'e',
                resize: function(event, ui) {
                    var parentWidth = $(this).parent().width();
                    var column1Width = $(this).width();
                    var column2Width = parentWidth - column1Width;
                    $("#trend1").width(column2Width);
                    //table.columns.adjust().draw();
                }
            });
            $("#barrierdf").resizable({
                handles: 'e',
                resize: function(event, ui) {
                    var parentWidth = $(this).parent().width();
                    var column1Width = $(this).width();
                    var column2Width = parentWidth - column1Width;
                    $("#barrier1").width(column2Width);
                }
            });
            //$("#shapedf").resizable({
            //    handles: 'e',
            //    resize: function(event, ui) {
            //        var parentWidth = $(this).parent().width();
            //        var column1Width = $(this).width();
            //        var column2Width = parentWidth - column1Width;
            //        $("#shape1").width(column2Width);
            //    }
            //});

            $('#table_id').DataTable({
                ajax: {
                    url: 'http://localhost:5000/data',
                    dataSrc: ''
                },
                columns: [
                    { data: 'A' },
                    { data: 'B' }
                ],

            });

            // ------------------ r3 ------------------
            var tb_bar = $('#tb_barrier').DataTable({
                select: true, // 允许选择行
                className: 'mydatatable',
                // 设置datatable的选项
                ajax: '/r3_data', // 从/data路由获取数据
                columns: [ // 设置列的名称和数据源
                    { title: 'barid', data: 'barid'},
                    { title: '掩体级别', data: 'bar_level'},
                    { title: '掩体类型', data: 'bar_type' },
                    { title: '掩体线', data: 'bar_line' },
                ],
                columnDefs: [
                    {
                        targets: [0], // 这里的0是列的索引，表示第1列（索引从0开始）
                        visible: false,
                        searchable: false
                    }
                ]
            });

            tb_bar.on('select.dt', function(e, dt, type, indexes) {
                if (type === 'row') {
                    var data = dt.rows(indexes).data()
                    // {#var index = table.row({ selected: true }).index();#}
                    $('#r3_barrier_level').val(data[0]['bar_level']);
                    $('#r3_barrier_type').val(data[0]['bar_type']);
                    $('#r3_line').val(data[0]['bar_line']);
                }
            });

            $('#r3_line_set').click(function() {
                r3line_set_type = 1 - r3line_set_type;
                if (r3line_set_type == 0) { // 清空 chartDiv 和 drawnPoints
                    var numTraces = chartDiv.data.length;
                    var tracesToDelete = Array.from({length: numTraces - 1}, (v, i) => i + 1);
                    Plotly.deleteTraces(chartDiv, tracesToDelete);
                    drawnLine = [];
                    document.getElementById('r3_line_set').innerHTML = '设置';
                    document.getElementById("r2_pt_set").disabled = false;
                    document.getElementById("r2_line_set").disabled = false;
                }
                else { // 设置 chartDiv 和 drawnPoints
                    var pts = $('#r3_line').val();
                    drawnLine = pts.split(',')//JSON.parse('[' + pts + ']');
                    //alert(drawnLine)
                    if (drawnLine.length == 2) {
                        // 获取图形对象
                        let firstTraceData = chartDiv.data[0]; // 第一个trace
                        let xData = firstTraceData.x; // 获取x轴数据
                        // 打印x轴数据
                        var xy0 = drawnLine[0].split('_');
                        var xy1 = drawnLine[1].split('_');
                        var xx0 = '';
                        var xx1 = '';
                        for (let i = 0; i < xData.length; i++) {
                            var date1 = new Date(xData[i]);
                            var date1 = date1.toISOString().slice(0, -5).replace('T', ' ');
                            if (date1 == xy0[0]) { xx0 = xData[i]; xx0_id = i}
                            if (date1 == xy1[0]) { xx1 = xData[i]; xx1_id = i }
                        }
                        if ((xx0 !== "") && (xx1 !== "")) {
                            // xaxis 的 范围
                            var xminx = xData[0]
                            var xmaxx = xData[xData.length-1]
                            var xmin = 0; //chartDiv.layout.xaxis.range[0];
                            var xmax = xData.length-1; //chartDiv.layout.xaxis.range[1];
                            // 计算斜率和截距
                            var x1 = xx0_id;
                            var x2 = xx1_id;
                            var y1 = Number(xy0[1]);
                            var y2 = Number(xy1[1]);
                            var slope = (y2 - y1) / (x2 - x1);
                            var intercept = y1 - slope * x1;
                            var yStart = slope * xmin + intercept;
                            var yEnd = slope * xmax + intercept;
                            // 绘制线
                            Plotly.addTraces(chartDiv, {
                                mode: 'lines',
                                //name: '直线',
                                x: [xminx, xmaxx],
                                y: [ yStart , yEnd ],
                                line: { color:'royalblue', width: 2}
                            });
                        }
                    } else {
                        drawnLine = [];
                    }
                    document.getElementById('r3_line_set').innerHTML = '结束';
                    document.getElementById("r2_pt_set").disabled = true;
                    document.getElementById("r2_line_set").disabled = true;
                }
                //alert(pt_set_type)
            });

            // 当点击id为add的按钮时，执行以下函数
            $('#r3_add').click(function() {
                // 获取输入框中的数据
                var bar_level = $('#r3_barrier_level').val();
                var bar_type = $('#r3_barrier_type').val();
                var bar_line = $('#r3_line').val();
                $.post('/add', {
                    type: 'r3',
                    bar_level: bar_level,
                    bar_type: bar_type,
                    bar_line: bar_line,
                }, function(response) {
                    // 如果响应成功，清空输入框，并重新加载datatable的数据
                    if (response.success) {
                        $('#r3_barrier_level').val('');
                        $('#r3_barrier_type').val('');
                        $('#r3_line').val('');
                        tb_bar.ajax.reload();
                    }
                });
            });

            // 当点击id为delete的按钮时，执行以下函数
            $('#r3_delete').click(function() {
                // 获取datatable中选中的行的索引
                var index = tb_bar.row({ selected: true }).index();
                // 根据索引获取对应行的数据
                var data = tb_bar.row(index).data();
                var barid = data['barid']

                // 发送一个post请求，向/delete路由发送数据
                $.post('/delete', {
                    type: 'r3',
                    barid: barid
                }, function(response) {
                    // 如果响应成功，重新加载datatable的数据
                    if (response.success) {
                        tb_bar.ajax.reload();
                    }
                });
            });

            // 当点击id为update的按钮时，执行以下函数
            $('#r3_update').click(function() {
                // 获取datatable中选中的行的索引
                var index = tb_bar.row({ selected: true }).index();
                // 根据索引获取对应行的数据
                var data = tb_bar.row(index).data();
                var barid = data['barid']

                // 获取输入框中的数据
                var bar_level = $('#r3_barrier_level').val();
                var bar_type = $('#r3_barrier_type').val();
                var bar_line = $('#r3_line').val();
                //alert(barid)
                // 发送一个post请求，向/update路由发送数据
                $.post('/update', {
                    type: 'r3',
                    barid: barid,
                    bar_level: bar_level,
                    bar_type: bar_type,
                    bar_line: bar_line
                }, function(response) {
                    // 如果响应成功，清空输入框，并重新加载datatable的数据--？这个不需要
                    if (response.success) {
                        tb_bar.ajax.reload();
                        alert('更新成功！')
                    }
                });
            });

            // ------------------ r2 ------------------
            var table = $('#tb_trend').DataTable({
                select: true, // 允许选择行
                className: 'mydatatable',
                // 设置datatable的选项
                ajax: '/r2_data', // 从/data路由获取数据
                columns: [ // 设置列的名称和数据源
                    { title: 'id', data: 'id'},
                    { title: '周期', data: 'period_type'},
                    { title: '起始时间', data: 'stdt' },
                    { title: '终止时间', data: 'endt' },
                    { title: '方向', data: 'trend_dir' },
                    { title: '波段类型', data: 'trend_type' },
                    { title: '点列表', data: 'pts'}, //width: '30%'}, // '100px' },
                    { title: '趋势线', data: 'line' },
                    { title: '形态', data: 'typelist' },
                ],
                columnDefs: [
                    {
                        targets: [0], // 这里的0是列的索引，表示第1列（索引从0开始）
                        visible: false,
                        searchable: false
                    }
                ]
            });

            table.on('select.dt', function(e, dt, type, indexes) {
                if (type === 'row') {
                    var data = dt.rows(indexes).data()
                    // {#var index = table.row({ selected: true }).index();#}
                    $('#r2_period_type').val(data[0]['period_type']);
                    $('#r2_stdt').val(data[0]['stdt']);
                    $('#r2_endt').val(data[0]['endt']);
                    $('#r2_trend_dir').val(data[0]['trend_dir']);
                    $('#r2_trend_type').val(data[0]['trend_type']);
                    $('#r2_pts').val(data[0]['pts']);
                    $('#r2_line').val(data[0]['line']);

                    // 这是您的选中列表
                    var selectedOptions = data[0]['typelist'].slice(1, -1).split(", ");
                    // 获取select元素
                    var select_typelist = document.getElementById('r2_typelist');
                    // 遍历所有的option元素
                    for (var i = 0; i < select_typelist.options.length; i++) {
                        var optionElement = select_typelist.options[i];
                        optionElement.selected = false;
                        selectedOptions.forEach(function(str1) {
                            if (str1 == "'" + optionElement.value + "'") {
                                optionElement.selected = true;
                            }
                        });
                    }
                }
            });

            $('#r2_pt_set').click(function() {
                pt_set_type = 1 - pt_set_type;
                if (pt_set_type == 0) { // 清空 chartDiv 和 drawnPoints
                    var numTraces = chartDiv.data.length;
                    var tracesToDelete = Array.from({length: numTraces - 1}, (v, i) => i + 1);
                    Plotly.deleteTraces(chartDiv, tracesToDelete);
                    drawnPoints = {};
                    document.getElementById('r2_pt_set').innerHTML = '设置';
                    document.getElementById("r2_line_set").disabled = false;
                    document.getElementById("r3_line_set").disabled = false;
                }
                else { // 设置 chartDiv 和 drawnPoints
                    var pts = $('#r2_pts').val();
                    var ptslist = pts.split(',')//JSON.parse('[' + pts + ']');
                    //alert(ptslist)
                    drawnPoints = ptslist.reduce(function(acc, cur, index) {
                        acc[cur] = index + 1;
                        return acc;
                    }, {});
                    //alert(drawnPoints);

                    // 获取图形对象
                    let firstTraceData = chartDiv.data[0]; // 第一个trace
                    let xData = firstTraceData.x; // 获取x轴数据
                    // 打印x轴数据
                    //alert(xData);

                    ptslist.forEach(function(str) {
                        var keys2 = str.split('_');
                        var x = keys2[0];
                        var m_upordn = Number(keys2[1]);
                        // xData 中 寻找 x
                        var index_x = -1;

                        for (let i = 0; i < xData.length; i++) {
                            var date1 = new Date(xData[i]);
                            var date1 = date1.toISOString().slice(0, -5).replace('T', ' ');
                            if (date1 == x) { index_x = i + 1;  } // alert(index_x)
                        }

                        if (index_x >= 0) {
                            x = firstTraceData.x[index_x];
                            if (m_upordn > 0) {
                                var y = firstTraceData.high[index_x];
                            } else {
                                var y = firstTraceData.low[index_x];
                            }
                            // 绘制点
                            Plotly.addTraces(chartDiv, {
                                x: [x],
                                y: [y],
                                mode: 'markers',
                                marker: {size: 10, color: 'blue'}
                            });
                        }
                    });
                    document.getElementById('r2_pt_set').innerHTML = '结束';
                    document.getElementById("r2_line_set").disabled = true;
                    document.getElementById("r3_line_set").disabled = true;
                }
                //alert(pt_set_type)
            });

            $('#r2_line_set').click(function() {
                line_set_type = 1 - line_set_type;
                if (line_set_type == 0) { // 清空 chartDiv 和 drawnPoints
                    var numTraces = chartDiv.data.length;
                    var tracesToDelete = Array.from({length: numTraces - 1}, (v, i) => i + 1);
                    Plotly.deleteTraces(chartDiv, tracesToDelete);
                    drawnLine = [];
                    document.getElementById('r2_line_set').innerHTML = '设置';
                    document.getElementById("r2_pt_set").disabled = false;
                    document.getElementById("r3_line_set").disabled = false;

                }
                else { // 设置 chartDiv 和 drawnPoints
                    var pts = $('#r2_line').val();
                    drawnLine = pts.split(',')//JSON.parse('[' + pts + ']');
                    //alert(drawnLine)
                    if (drawnLine.length == 2) {

                        // 获取图形对象
                        let firstTraceData = chartDiv.data[0]; // 第一个trace
                        let xData = firstTraceData.x; // 获取x轴数据
                        // 打印x轴数据
                        var xy0 = drawnLine[0].split('_');
                        var xy1 = drawnLine[1].split('_');
                        var xx0 = '';
                        var xx1 = '';
                        for (let i = 0; i < xData.length; i++) {
                            var date1 = new Date(xData[i]);
                            var date1 = date1.toISOString().slice(0, -5).replace('T', ' ');
                            if (date1 == xy0[0]) { xx0 = xData[i]; xx0_id = i}
                            if (date1 == xy1[0]) { xx1 = xData[i]; xx1_id = i }
                        }
                        if ((xx0 !== "") && (xx1 !== "")) {
                            // xaxis 的 范围
                            var xminx = xData[0]
                            var xmaxx = xData[xData.length-1]
                            var xmin = 0; //chartDiv.layout.xaxis.range[0];
                            var xmax = xData.length-1; //chartDiv.layout.xaxis.range[1];
                            // 计算斜率和截距
                            var x1 = xx0_id;
                            var x2 = xx1_id;
                            var y1 = Number(xy0[1]);
                            var y2 = Number(xy1[1]);
                            var slope = (y2 - y1) / (x2 - x1);
                            var intercept = y1 - slope * x1;
                            var yStart = slope * xmin + intercept;
                            var yEnd = slope * xmax + intercept;
                            // 绘制线
                            Plotly.addTraces(chartDiv, {
                                mode: 'lines',
                                //name: '直线',
                                x: [xminx, xmaxx],
                                y: [ yStart , yEnd ],
                                line: { color:'royalblue', width: 2}
                            });
                        }
                        // 绘制线 TODO 修改
                        //Plotly.addTraces(chartDiv, {
                        //    mode: 'lines',
                        //    //name: '直线',
                        //    x: [x0, x],
                        //    y: [y0, y],
                        //    line: { color:'royalblue', width: 2}
                        //});

                    } else {
                        drawnLine = [];
                    }
                    document.getElementById('r2_line_set').innerHTML = '结束';
                    document.getElementById("r2_pt_set").disabled = true;
                    document.getElementById("r3_line_set").disabled = true;
                }
                //alert(pt_set_type)
            });


            // 当点击id为add的按钮时，执行以下函数
            $('#r2_add').click(function() {
                // 获取输入框中的数据
                var select_period_type = document.getElementById("r2_period_type");
                var period_type = select_period_type.options[select_period_type.selectedIndex].value;

                var stdt = $('#r2_stdt').val();
                var endt = $('#r2_endt').val();
                // var trend_dir = $('#r2_trend_dir').val();
                var select_trend_dir = document.getElementById("r2_trend_dir");
                var trend_dir = select_trend_dir.options[select_trend_dir.selectedIndex].value;

                var trend_type = $('#r2_trend_type').val();
                var pts = $('#r2_pts').val();
                var line = $('#r2_line').val();
                var typelist = $('#r2_typelist').val();

                //alert(line)
                // 发送一个post请求，向/add路由发送数据
                $.post('/add', {
                    type: 'r2',
                    period_type: period_type,
                    stdt: stdt,
                    endt: endt,
                    trend_dir:trend_dir,
                    trend_type:trend_type,
                    pts: pts,
                    line: line,
                    typelist: typelist
                }, function(response) {
                    // 如果响应成功，清空输入框，并重新加载datatable的数据
                    if (response.success) {
                        $('#r2_period_type').val('');
                        $('#r2_stdt').val('');
                        $('#r2_endt').val('');
                        $('#r2_trend_dir').val('');
                        $('#r2_trend_type').val('');
                        $('#r2_pts').val('');
                        $('#r2_line').val('');
                        $('#r2_typelist').val('');
                        table.ajax.reload();
                    }
                });
            });

            // 当点击id为delete的按钮时，执行以下函数
            $('#r2_delete').click(function() {
                // 获取datatable中选中的行的索引
                var index = table.row({ selected: true }).index();
                // 根据索引获取对应行的数据
                var data = table.row(index).data();
                var id = data['id']

                // 发送一个post请求，向/delete路由发送数据
                $.post('/delete', {
                    type: 'r2',
                    id: id
                }, function(response) {
                    // 如果响应成功，重新加载datatable的数据
                    if (response.success) {
                        table.ajax.reload();
                    }
                });
            });

            // 当点击id为update的按钮时，执行以下函数
            $('#r2_update').click(function() {
                // 获取datatable中选中的行的索引
                var index = table.row({ selected: true }).index();
                // 根据索引获取对应行的数据
                var data = table.row(index).data();
                var id = data['id']

                // 获取输入框中的数据
                var select_period_type = document.getElementById("r2_period_type");
                var period_type = select_period_type.options[select_period_type.selectedIndex].value;

                var stdt = $('#r2_stdt').val();
                var endt = $('#r2_endt').val();
                //var trend_dir = $('#r2_trend_dir').val();
                var select_trend_dir = document.getElementById("r2_trend_dir");
                var trend_dir = select_trend_dir.options[select_trend_dir.selectedIndex].value;

                var trend_type = $('#r2_trend_type').val();
                var pts = $('#r2_pts').val();
                var line = $('#r2_line').val();
                var typelist = $('#r2_typelist').val();

                // alert(typelist)

                // 发送一个post请求，向/update路由发送数据
                $.post('/update', {
                    type: 'r2',
                    id: id,
                    period_type: period_type,
                    stdt: stdt,
                    endt: endt,
                    trend_dir:trend_dir,
                    trend_type:trend_type,
                    pts: pts,
                    line: line,
                    typelist: typelist
                }, function(response) {
                    // 如果响应成功，清空输入框，并重新加载datatable的数据--？这个不需要
                    if (response.success) {
                        //TODO: 但是应该有所相应！
                        table.ajax.reload();
                        alert('更新成功！')
                    }
                });
            });
        });

        $( function() {
            $("#stdt").datepicker({dateFormat:"yy-mm-dd"});
            $("#endt").datepicker({dateFormat:"yy-mm-dd"});
            $("#r2_stdt").datepicker({dateFormat:"yy-mm-dd"});
            $("#r2_endt").datepicker({dateFormat:"yy-mm-dd"});

            $("#row1" ).resizable({handles:'s'});
            $("#row2" ).resizable({handles:'s'});
            $("#row3" ).resizable({handles:'s'});
            {#$("#row4" ).resizable({handles:'s'});#}

            $("#barfig").resizable({handles: 'e',
                    resize: function(event, ui) {
                        var parentWidth = $(this).parent().width();
                        var column1Width = $(this).width();
                        var column2Width = parentWidth - column1Width;
                        $("#warninglist").width(column2Width);
                        //document.querySelector('[data-title="Autoscale"]').click()
                    }
            });
            $("#trenddf").resizable({handles: 'e',
                    resize: function(event, ui) {
                        var parentWidth = $(this).parent().width();
                        var column1Width = $(this).width();
                        var column2Width = parentWidth - column1Width;
                        $("#trend1").width(column2Width);
                    }
            });
            $("#barrierdf").resizable({
                handles: 'e',
                resize: function(event, ui) {
                    var parentWidth = $(this).parent().width();
                    var column1Width = $(this).width();
                    var column2Width = parentWidth - column1Width;
                    $("#barrier1").width(column2Width);
                }
            });
            //$("#shapedf").resizable({
            //    handles: 'e',
            //    resize: function(event, ui) {
            //        var parentWidth = $(this).parent().width();
            //        var column1Width = $(this).width();
            //        var column2Width = parentWidth - column1Width;
            //        $("#shape1").width(column2Width);
            //    }
            //});
        } );

        // 监听mousedown事件
        chartDiv.addEventListener('mousedown', function(event){
            // 记录鼠标按键
            mouseButton = event.button;
        });

        chartDiv.addEventListener('contextmenu', function (event) {
            if ((pt_set_type == 1) || (line_set_type==1) || (r3line_set_type==1) ) {
                event.preventDefault();
            }
        });

        chartDiv.on('plotly_click', function(data){
            if (pt_set_type == 1) {
                var x = data.points[0].x; // data.points[0].x;
                var index_x = data.points[0].pointNumber;

                var date1 = new Date(x);
                var date1 = date1.toISOString().slice(0, -5).replace('T', ' ');
                key1 = date1+ '_' + String(1 - mouseButton);

                // 检查该点是否已经被绘制
                if(drawnPoints.hasOwnProperty(key1)) {
                    // 如果该点已经被绘制，那么删除该点
                    // alert('del'+key1)
                    Plotly.deleteTraces(chartDiv, drawnPoints[key1]);
                    for(var key in drawnPoints) {
                        if (drawnPoints[key] > drawnPoints[key1]) {
                            drawnPoints[key] -= 1
                        }
                    }
                    delete drawnPoints[key1];
                } else {
                    if (mouseButton == 0) {
                        var y = data.points[0].data.high[index_x];
                    } else {
                        var y = data.points[0].data.low[index_x];
                    }
                    // 如果该点没有被绘制，那么绘制该点
                    Plotly.addTraces(chartDiv, {
                        x: [x],
                        y: [y],
                        mode: 'markers',
                        marker: {size: 10, color: 'blue'}
                    });
                    // 记录该点已经被绘制
                    // drawnPoints[x.toString()] = 1 - mouseButton; //chartDiv.data.length - 1;
                    drawnPoints[key1] = chartDiv.data.length - 1; // 1
                }
                document.getElementById('warninglist').innerHTML = ''
                // 使用for...in循环遍历对象的所有键值和数值
                for(var key in drawnPoints) {
                    document.getElementById('warninglist').innerHTML += '键：' + key + '，值：' + drawnPoints[key] + '<br>';
                    // 在网页中显示键值和数值
                    //document.write('键：' + key + '，值：' + drawnPoints[key] + '<br>');
                }

                var pts = Object.keys(drawnPoints);
                pts.sort(); //function(a, b) {return a - b; });
                $('#r2_pts').val(String(pts));
                //document.getElementById('warninglist').innerHTML += drawnPoints[x.toString()] ;
            }
            else if ((line_set_type == 1) || (r3line_set_type==1)) { // 每次保留第一个点，更改第二个点！
                var x = data.points[0].x; // data.points[0].x;
                var index_x = data.points[0].pointNumber;

                var date1 = new Date(x);
                var date1 = date1.toISOString().slice(0, -5).replace('T', ' ');
                if (mouseButton == 0) {
                    var y = data.points[0].data.high[index_x];
                } else {
                    var y = data.points[0].data.low[index_x];
                }
                key1 = date1+ '_' + parseFloat(y.toFixed(3)).toString(); //String(1 - mouseButton);
                //alert(key1);
                // 检查该点是否已经被绘制
                if(drawnLine[0] == key1) { // 清除第一个点
                    //alert('d1')
                    drawnLine.splice(0,1)
                }
                else if (drawnLine[1] == key1) { // 清除第二个点
                    //alert('d2')
                    drawnLine.splice(1,1)
                } else {
                    //alert('new1')
                    if (drawnLine.length == 2) { // 如果已经达到2个点了，删除之前的第二个点！
                        drawnLine.splice(1,1)
                    }
                    drawnLine.push(key1)
                }

                // 去掉之前绘制的 点 or 趋势线
                if (chartDiv.data.length > 1) {
                    Plotly.deleteTraces(chartDiv, 1);
                }

                let firstTraceData = chartDiv.data[0]; // 第一个trace
                let xData = firstTraceData.x; // 获取x轴数据

                if (drawnLine.length == 1) {
                    var xy = drawnLine[0].split('_')
                    for (let i = 0; i < xData.length; i++) {
                        var date1 = new Date(xData[i]);
                        var date1 = date1.toISOString().slice(0, -5).replace('T', ' ');
                        if (date1 == xy[0]) {
                            // 绘制点
                            Plotly.addTraces(chartDiv, {
                                x: [ xData[i] ],
                                y: [ Number(xy[1]) ],
                                mode: 'markers',
                                marker: {size: 10, color: 'blue'}
                            });
                        } // alert(index_x)
                    }
                } else {
                    var xy0 = drawnLine[0].split('_');
                    var xy1 = drawnLine[1].split('_');
                    var xx0 = '';
                    var xx1 = '';
                    for (let i = 0; i < xData.length; i++) {
                        var date1 = new Date(xData[i]);
                        var date1 = date1.toISOString().slice(0, -5).replace('T', ' ');
                        if (date1 == xy0[0]) { xx0 = xData[i]; xx0_id = i}
                        if (date1 == xy1[0]) { xx1 = xData[i]; xx1_id = i }
                    }
                    if ((xx0 !== "") && (xx1 !== "")) {
                        // xaxis 的 范围
                        var xminx = xData[0]
                        var xmaxx = xData[xData.length-1]
                        var xmin = 0; //chartDiv.layout.xaxis.range[0];
                        var xmax = xData.length-1; //chartDiv.layout.xaxis.range[1];
                        // 计算斜率和截距
                        var x1 = xx0_id;
                        var x2 = xx1_id;
                        var y1 = Number(xy0[1]);
                        var y2 = Number(xy1[1]);
                        var slope = (y2 - y1) / (x2 - x1);
                        var intercept = y1 - slope * x1;
                        var yStart = slope * xmin + intercept;
                        var yEnd = slope * xmax + intercept;
                        // 绘制线
                        Plotly.addTraces(chartDiv, {
                            mode: 'lines',
                            //name: '直线',
                            x: [xminx, xmaxx],
                            y: [ yStart , yEnd ],
                            line: { color:'royalblue', width: 2}
                        });
                    }
                }
                drawnLine.sort(); //function(a, b) {return a - b; });
                document.getElementById('warninglist').innerHTML = String(drawnLine)
                if (r3line_set_type == 1) {
                    $('#r3_line').val(String(drawnLine));
                }
                else { //r2
                    $('#r2_line').val(String(drawnLine));
                }

            }

            /////////////////////---------------之前的一些测试保留 ---------------------
            // var index = data.points[0].pointNumber;
            // var x = data.points[0].x;

            //var y = data.points[0].yc; //yo, yh, yl, yc
            //var y = data.points[0]; //yaxis.d2l(data.points[0].y);
            //alert('你点击了坐标 (' + x + ', ' + y + ')');
            //document.getElementById('warninglist').innerHTML = x + data.points[0].high ;

        });

        // 定时运行的函数
        setInterval(function() {
            $.getJSON('/refresh_data', function(new_data) {
                var trace = {
                    x: new_data['index'],
                    open: new_data['open'],
                    high: new_data['high'],
                    low: new_data['low'],
                    close: new_data['close'],
                    //type: //'candlestick','category'
                };
                //Plotly.react('barfig', [trace]);
                //Plotly.newPlot('barfig', [trace], layout1);
            });
        }, 500000000); // 5000ms = 5s

        $('#futid').change(function () {
            var futid = $('#futid').val();
            $.ajax({
                url: '/fut_change',
                data: {'futid': futid},
                type: 'POST',
                success: function(monthlist) {
                    //alert(monthlist)
                    // 获取select元素
                    var select = document.getElementById("monthid");
                    while(select.options.length > 0){ select.remove(0); }
                    // 使用获取的数据填充select
                    for(var i = 0; i < monthlist.length; i++) {
                        var opt = monthlist[i];
                        var el = document.createElement("option");
                        el.textContent = opt;
                        el.value = opt;
                        select.appendChild(el);
                    }
                }
            });
        });

        $('#r2_period_type').change(function () {
            var period_type = $('#r2_period_type').val();
            $.ajax({
                url: '/period_change',
                data: {'period_type': period_type},
                type: 'POST',
                success: function(monthlist) {
                    //alert(r2_typelist)
                    // 获取select元素
                    var select = document.getElementById("r2_typelist");
                    while(select.options.length > 0){ select.remove(0); }
                    // 使用获取的数据填充select
                    for(var i = 0; i < monthlist.length; i++) {
                        var opt = monthlist[i];
                        var el = document.createElement("option");
                        el.textContent = opt;
                        el.value = opt;
                        select.appendChild(el);
                    }
                }
            });
        });

        $( "#update_dtrange" ).click(function() {
            var futid = $('#futid').val();
            var monthid = $('#monthid').val();
            var bar_period = $('#bar_period').val();

            var stdt = $( "#stdt" ).val();
            var endt = $( "#endt" ).val();

            if (new Date(endt) < new Date(stdt))  {
                alert('结束日期小于起始日期！！');
            }
            $.ajax({
                url: '/update_dtrange',
                data: {'stdt': stdt, 'endt': endt,
                    'futid':futid,
                    'monthid':monthid,
                    'bar_period':bar_period,
                },
                type: 'POST',
                success: function(new_data) {
                    //alert(new_data)
                    //alert(new_data['index'][0])
                    var trace = {
                        x: [new_data['index']],
                        open: [new_data['open']],
                        high: [new_data['high']],
                        low: [new_data['low']],
                        close: [new_data['close']],
                        //type: 'candlestick',


                        margin:{b:10, l:50, r:10, t:50},
                        title:{text:'行情图'},
                        autosize: true,
                        //paper_bgcolor: 'black',
                        plot_bgcolor: 'black',
                        dragmode: 'zoom',
                        showlegend: false,
                        xaxis: {
                            showgrid: false,
                            gridcolor: 'gray',
                            autorange: true,
                            gridwidth: 0.5,
                            grid_dash: 'dash',
                            type: 'category', //'date', 'category'
                            tickmode: 'linear',
                            tick0: 0,
                            dtick: 5,
                            tickformat: '%Y-%m-%d %H:%M' // type:'date' 才有用
                        },
                        yaxis: {
                            gridcolor: 'gray',
                            autorange: true,
                            gridwidth: 1,
                            grid_dash: 'dashdot',
                            type: 'linear'
                        }

                    };

                    Plotly.update('barfig', trace);

                },
                error: function(error) {
                    console.log(error);
                }
            });
        });

        // 触发按钮的点击事件
        document.getElementById('update_dtrange').click();
        //selectElement.value = '日线';
        document.getElementById('r2_period_type').dispatchEvent(new Event('change'));

    </script>


</body>
</html>

